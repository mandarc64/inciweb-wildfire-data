<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Wildfire Incident Data</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Bootstrap 5 -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- DataTables -->
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.dataTables.min.css"
    />
    <!-- DataTables Buttons CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css"
    />

    <style>
      body {
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        font-family: "Segoe UI", Tahoma, sans-serif;
      }
      .header-section {
        text-align: center;
        padding: 40px 20px 20px;
      }
      .header-section h1 {
        font-size: 2.5rem;
        font-weight: bold;
        color: #dc3545;
        margin-bottom: 15px;
      }
      .header-paragraphs {
        display: flex;
        flex-wrap: wrap; /* Wrap on small screens */
        justify-content: center; /* Center horizontally */
        align-items: baseline; /* ‚úÖ Aligns all text on the same baseline */
        gap: 15px; /* Space between p tags */
      }

      .header-paragraphs p {
        margin: 0;
        font-size: 1rem;
        color: #6c757d;
        line-height: 1.5; /* ‚úÖ Consistent height */
        white-space: nowrap; /* ‚úÖ Prevents unwanted line breaks inside */
      }

      .header-paragraphs p b {
        font-weight: 600; /* Slightly less heavy than default <b> */
      }
      .card {
        background: #ffffff;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        padding: 20px;
        margin-top: 20px;
      }
      #lastUpdated {
        font-size: 0.95rem;
        color: #495057;
        margin-top: 10px;
      }
      select.form-select {
        border-radius: 8px;
        padding: 10px;
      }
      .loading {
        text-align: center;
        font-size: 1.1em;
        padding: 20px;
        color: #6c757d;
      }
      footer {
        text-align: center;
        margin-top: 40px;
        font-size: 0.85rem;
        color: #6c757d;
      }
      .flights-block table {
        background: #fff;
      }
      .flights-block strong {
        display: inline-block;
        margin-bottom: 0.25rem;
      }
    </style>
  </head>
  <body>
    <!-- HEADER -->
    <div class="header-section">
      <h1>üî• Wildfire Incident Dashboard</h1>
      <!-- ‚úÖ Wrap p tags in a flex container -->
      <div class="header-paragraphs">
        <p>Live wildfire data auto-fetched from InciWeb</p>
        <p id="lastUpdated" class="text-muted">
          ‚è≥ Loading last update time...
        </p>
        <p>üìÖ The data shown here is from Sat, July 26, 2025</p>
      </div>
    </div>

    <div class="container">
      <!-- CARD UI -->
      <div class="card">
        <h5 class="text-center mb-3">Select an Incident</h5>
        <div class="mb-4 text-center">
          <select id="csvSelect" class="form-select w-50 mx-auto"></select>
          <!-- CHARTS -->
          <div class="row">
            <div class="col-md-6">
              <canvas id="acresChart"></canvas>
            </div>
            <div class="col-md-6">
              <canvas id="containmentChart"></canvas>
            </div>
          </div>
        </div>

        <!-- TABLE -->
        <div id="tableContainer" class="table-responsive">
          <div class="loading">Loading available CSV files...</div>
          <table
            id="incidentTable"
            class="display nowrap table table-striped table-hover align-middle"
            style="width: 100%"
          ></table>
        </div>
      </div>
    </div>

    <!-- FOOTER -->
    <footer>
      üöÄ Built with ‚ù§Ô∏è | Last refreshed dynamically from GitHub API
    </footer>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <!-- PapaParse for CSV -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

    <!-- DataTables -->
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>

    <!-- JSZip for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <!-- pdfmake for PDF export (optional) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>

    <!-- DataTables Buttons -->
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>

    <script>
      const GITHUB_USER = "mandarc64";
      const GITHUB_REPO = "inciweb-wildfire-data";
      const CSV_FOLDER = "inciweb_data";

      // const csvBaseURL = `https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/feature/flight-logic/${CSV_FOLDER}/`;
      // const apiURL = `https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/${CSV_FOLDER}`;

      const csvSelect = document.getElementById("csvSelect");
      const tableContainer = document.getElementById("tableContainer");
      const lastUpdatedEl = document.getElementById("lastUpdated");

      const BRANCH = "master";
      const csvBaseURL = `https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/${BRANCH}/${CSV_FOLDER}/`;
      const apiURL = `https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/${CSV_FOLDER}?ref=${BRANCH}`;

      const FLIGHT_FOLDER = "flight_fire_data";
      const flightApiURL = `https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/${FLIGHT_FOLDER}?ref=${BRANCH}`;
      const MAX_FLIGHT_FILES = 60;

      let dataTable = null;

      // NEW  ‚úÖ
      let flightsData = [];
      const flightsReady = loadFlights();

      async function loadFlights() {
        try {
          console.log("[Flights] Listing files in", flightApiURL);
          const res = await fetch(flightApiURL);
          if (!res.ok) throw new Error("Failed to list flight files");
          const files = await res.json();

          // only CSVs
          const csvs = (files || []).filter(
            (f) => f.type === "file" && f.name.toLowerCase().endsWith(".csv")
          );
          if (!csvs.length) {
            console.warn("[Flights] No flight CSVs found.");
            flightsData = [];
            return;
          }

          // sort by name ASC (timestamps in your filenames are ISO-like ‚Üí lexicographic works)
          csvs.sort((a, b) => a.name.localeCompare(b.name));

          // take the last K files
          const recent = csvs.slice(-MAX_FLIGHT_FILES);
          console.log(
            `[Flights] Will load ${recent.length} of ${csvs.length} files (limit=${MAX_FLIGHT_FILES}).`
          );

          // helper to parse one CSV into rows
          const parseOne = (name) =>
            new Promise((resolve) => {
              const url = `https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/${BRANCH}/${FLIGHT_FOLDER}/${name}`;
              Papa.parse(url, {
                download: true,
                header: true,
                skipEmptyLines: true,
                complete: (r) => resolve(r.data || []),
                error: (e) => {
                  console.warn("[Flights] parse error for", name, e);
                  resolve([]);
                },
              });
            });

          // load all recent CSVs
          const allArrays = await Promise.all(
            recent.map((f) => parseOne(f.name))
          );
          const combined = allArrays.flat();
          console.log(
            `[Flights] Loaded ${combined.length} rows before de-dup.`
          );

          // de-dup: keep the newest file‚Äôs row
          // because we processed files in ascending order, later files overwrite earlier entries
          const byKey = new Map();
          const keyOf = (r) =>
            `${r.TailNumber || ""}|${r.FlightDate || ""}|${r.Origin || ""}|${
              r.Destination || ""
            }|${r.FireIncident || ""}`;

          for (const row of combined) {
            byKey.set(keyOf(row), row); // later (newer) rows replace earlier ones
          }

          flightsData = Array.from(byKey.values());
          console.log(`[Flights] After de-dup: ${flightsData.length} rows.`);

          // optional debug preview
          if (flightsData.length) {
            console.log("[Flights] Sample row:", flightsData[0]);
          }
        } catch (e) {
          console.error("Flight data load error:", e);
          flightsData = [];
        }
      }

      // ‚úÖ Fetch CSV file list dynamically from GitHub API
      async function fetchCSVList() {
        try {
          const res = await fetch(apiURL);
          if (!res.ok) throw new Error("Failed to fetch file list");
          const files = await res.json();

          // Filter only .csv files
          const csvFiles = files
            .filter((file) => file.name.endsWith(".csv"))
            .map((file) => file.name)
            .sort();

          if (csvFiles.length === 0) {
            tableContainer.innerHTML = "<p>No CSV files found in repo.</p>";
            return;
          }

          // Populate dropdown dynamically
          csvSelect.innerHTML = "";
          csvFiles.forEach((file) => {
            const opt = document.createElement("option");
            opt.value = file;
            opt.textContent = file.replace(".csv", "").replace(/_/g, " ");
            csvSelect.appendChild(opt);
          });

          // Load first file by default
          loadCSV(csvFiles[0]);

          // Add change listener
          csvSelect.addEventListener("change", (e) => loadCSV(e.target.value));
        } catch (err) {
          console.error("Error fetching CSV list:", err);
          tableContainer.innerHTML = `<p>Error loading CSV list. Check console.</p>`;
        }
      }

      // ‚úÖ Load and parse CSV file
      function loadCSV(filename) {
        const csvURL = csvBaseURL + filename;
        console.log("Loading CSV:", csvURL);

        tableContainer.innerHTML = `<div class="loading">Loading ${filename}...</div>`;
        lastUpdatedEl.innerText = "‚è≥ Fetching last update time...";

        Papa.parse(csvURL, {
          download: true,
          header: true,
          skipEmptyLines: true,
          complete: async function (results) {
            console.log("Parsed CSV:", results.data);

            const data = results.data || [];
            await flightsReady; // ‚è≥ ensure flight CSV is loaded
            const enriched = attachFlightsToRows(data); // ‚ûï add flights per row

            // ‚úÖ Update "Last Updated" timestamp dynamically
            updateLastUpdated(data);

            // ‚úÖ Render table
            renderTable(enriched);

            // ‚úÖ Render charts
            renderCharts(enriched);
          },
        });
      }

      function parseUpdatedAgoToMs(s = "") {
        let ms = 0;
        const day = s.match(/(\d+)\s*day/);
        const hr = s.match(/(\d+)\s*hour/);
        const min = s.match(/(\d+)\s*min/);
        if (day) ms += Number(day[1]) * 86400000;
        if (hr) ms += Number(hr[1]) * 3600000;
        if (min) ms += Number(min[1]) * 60000;
        return ms;
      }

      // ‚úÖ Compute and display "Last updated at ..."
      function updateLastUpdated(data) {
        if (!data || data.length === 0) {
          lastUpdatedEl.innerText = "‚ö†Ô∏è No data available.";
          return;
        }

        // Get the most recent ScrapeDate from all rows
        const latestDate = data.reduce((latest, row) => {
          const d = new Date(row.ScrapeDate);
          return d > latest ? d : latest;
        }, new Date(0));

        if (!latestDate || isNaN(latestDate)) {
          lastUpdatedEl.innerText = "‚ö†Ô∏è Could not determine last update.";
          return;
        }

        // Format nicely in PST
        const formatted = latestDate.toLocaleString("en-US", {
          weekday: "short",
          year: "numeric",
          month: "short",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit",
          timeZone: "America/Los_Angeles",
        });

        lastUpdatedEl.innerHTML = `‚úÖ Updated daily at <b>8:00 AM PST</b> | <strong>Last data update:</strong> ${formatted}`;
      }

      // ‚úÖ Render DataTable
      function renderTable(data) {
        tableContainer.innerHTML = `<table id="incidentTable" class="display nowrap table table-striped" style="width:100%"></table>`;

        if (!data || data.length === 0) {
          tableContainer.innerHTML = "<p>No data found.</p>";
          return;
        }

        // ‚úÖ Get headers dynamically from the FIRST row
        const headers = Object.keys(data[0]).filter((h) => h !== "flights");
        console.log("Detected Headers:", headers);

        const columns = headers
          .filter((col) => col !== "flights") // ‚¨ÖÔ∏è hide the raw flights array
          .map((col) => ({ title: col, data: col }));

        // ‚úÖ Which column index is ScrapeDate?
        const scrapeDateIdx = headers.indexOf("ScrapeDate");
        // Fallback to the first column if ScrapeDate isn't found
        const initialOrderIdx = scrapeDateIdx === -1 ? 0 : scrapeDateIdx;

        // Add an extra column at the end for flight count
        columns.push({
          title: "Flights",
          data: "flights",
          orderable: false,
          render: (flights, type, row) => {
            const n = Array.isArray(flights) ? flights.length : 0;
            return n
              ? `<a href="#" class="show-flights" data-count="${n}">${n} flights</a>`
              : "‚Äî";
          },
        });

        // Destroy old DataTable if it exists
        if (dataTable) {
          dataTable.destroy();
        }

        dataTable = $("#incidentTable").DataTable({
          data: data,
          columns: columns,
          responsive: true,
          scrollX: true,
          pageLength: 10,
          autoWidth: false,
          columnDefs: [{ defaultContent: "-", targets: "_all" }],
          // ‚úÖ Default sort: ScrapeDate DESC (newest first)
          order: [[initialOrderIdx, "desc"]],
          // ‚úÖ NEW LINES FOR EXPORT BUTTONS
          dom: "Bfrtip", // Layout: Buttons, filter, table, pagination
          buttons: [
            {
              extend: "excelHtml5",
              text: "üì• Download Excel",
              title: "Wildfire Incident Data",
            },
            {
              extend: "csvHtml5",
              text: "üì• Download CSV",
              title: "Wildfire Incident Data",
            },
            {
              extend: "pdfHtml5",
              text: "üìÑ Download PDF",
              title: "Wildfire Incident Data",
              orientation: "landscape",
              pageSize: "A4",
            },
            "print",
          ],
        });

        // Row-level expander for flights (inject inside the existing Responsive child row)
        $("#incidentTable tbody").off("click", "a.show-flights"); // avoid double-binding on redraws
        $("#incidentTable tbody").on("click", "a.show-flights", function (e) {
          e.preventDefault();
          e.stopPropagation(); // ‚úã don't let Responsive toggle the row

          const dt = $("#incidentTable").DataTable();

          // If the link sits inside the child row, the closest <tr> will be .child.
          // Normalize to the *parent* data row:
          let $tr = $(this).closest("tr");
          if ($tr.hasClass("child")) $tr = $tr.prev("tr");

          const row = dt.row($tr);
          const rowData = row.data() || {};
          const flightCount = Array.isArray(rowData.flights)
            ? rowData.flights.length
            : 0;

          console.debug("[Flights click]", {
            rowIndex: row.index(),
            incident: rowData.Incident,
            scrapeDate: rowData.ScrapeDate,
            flights: flightCount,
          });

          // Ensure the Responsive details row is open
          let $child = $tr.next("tr.child");
          if (!$child.length || !$child.is(":visible")) {
            console.debug("Child row not open; opening now‚Ä¶");
            // Trigger Responsive's own toggle control so its details table is built
            $tr.find("td.dtr-control").trigger("click");
            $child = $tr.next("tr.child");
          }

          // The child row has a single <td> that contains the details table/markup.
          const $cell = $child.find("td");
          if (!$cell.length) {
            console.warn("No child-cell to inject into; bailing.");
            return;
          }

          // Toggle our injected block
          const EXISTING_SEL = ".flights-block";
          const $existing = $cell.find(EXISTING_SEL);
          if ($existing.length) {
            console.debug("Removing existing flights block (toggle off).");
            $existing.remove();
            return;
          }

          console.debug("Injecting flights block into child.");
          // Build and append the flights sub-table
          const html = `
            <div class="flights-block border-top mt-2 pt-2">
              ${formatFlightsRow(rowData)}
            </div>`;
          $cell.append(html);
        });
      }

      // ‚úÖ Start by fetching CSV list
      fetchCSVList();

      let acresChart = null;
      let containmentChart = null;

      function formatFlightsRow(rowData) {
        const flights = Array.isArray(rowData?.flights) ? rowData.flights : [];
        console.debug("formatFlightsRow()", {
          incident: rowData.Incident,
          count: flights.length,
        });
        if (!flights.length)
          return `<div class="p-2">No flights matched during this period.</div>`;

        const rows = flights
          .map(
            (f) => `
          <tr>
            <td>${f.FlightDate || ""}</td>
            <td>${f.TailNumber || ""}</td>
            <td>${f.Origin || ""}</td>
            <td>${f.Destination || ""}</td>
            <td>${f.DistanceKM || ""}</td>
          </tr>
        `
          )
          .join("");

        return `
          <div class="p-2">
            <strong>Matching flights (${flights.length})</strong>
            <table class="table table-sm table-bordered mt-2 mb-0">
              <thead>
                <tr><th>Date</th><th>Tail #</th><th>Origin</th><th>Destination</th><th>Distance (km)</th></tr>
              </thead>
              <tbody>${rows}</tbody>
            </table>
          </div>
        `;
      }

      function renderCharts(data) {
        // Clean dates for X-axis
        const labels = data.map((d) => d.ScrapeDate);
        const acres = data.map(
          (d) => parseFloat(d.Size.replace(/[^\d.]/g, "")) || 0
        );
        const containment = data.map(
          (d) => parseFloat(d.ContainmentPercent?.replace("%", "")) || 0
        );

        // Destroy previous charts if needed
        if (acresChart) acresChart.destroy();
        if (containmentChart) containmentChart.destroy();

        // Chart 1: Acres Over Time
        acresChart = new Chart(document.getElementById("acresChart"), {
          type: "line",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Acres Burned",
                data: acres,
                fill: true,
                borderWidth: 2,
                borderColor: "rgba(255, 99, 132, 1)",
                backgroundColor: "rgba(255, 99, 132, 0.2)",
                tension: 0.3,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              title: { display: true, text: "Acres Burned Over Time" },
            },
            scales: {
              y: {
                beginAtZero: true,
                title: { display: true, text: "Acres Burned" },
              },
              x: { title: { display: true, text: "Date" } },
            },
          },
        });

        // Chart 2: Containment Over Time
        containmentChart = new Chart(
          document.getElementById("containmentChart"),
          {
            type: "line",
            data: {
              labels: labels,
              datasets: [
                {
                  label: "Containment %",
                  data: containment,
                  fill: false,
                  borderWidth: 2,
                  borderColor: "rgba(54, 162, 235, 1)",
                  tension: 0.3,
                },
              ],
            },
            options: {
              responsive: true,
              plugins: {
                title: { display: true, text: "Containment Percent Over Time" },
              },
              scales: {
                y: {
                  beginAtZero: true,
                  suggestedMax: 105, // Allow chart to go slightly above 100%
                  grace: "5%", // Add visual padding above the highest value
                  ticks: {
                    callback: (v) => v + "%",
                    stepSize: 10,
                  },
                  title: { display: true, text: "Containment %" },
                },

                x: { title: { display: true, text: "Date" } },
              },
            },
          }
        );
      }

      function attachFlightsToRows(fireRows) {
        return fireRows.map((fire) => {
          // Parse active window for this row
          const scrape = new Date(fire.ScrapeDate);
          const end = new Date(
            scrape.getTime() - parseUpdatedAgoToMs(fire.Updated || "")
          );
          // DateOfOrigin may include time/weekday; grab the date part if needed
          const startStr =
            (fire.DateOfOrigin || "").match(/\d{2}\/\d{2}\/\d{4}/)?.[0] ||
            fire.DateOfOrigin;
          const start = startStr ? new Date(startStr) : null;

          // If dates are missing, no flights
          if (!start || isNaN(start) || !end || isNaN(end)) {
            return { ...fire, flights: [] };
          }

          // Robust match: same Incident + FlightDate ‚àà [start, end]
          const matches = flightsData.filter((f) => {
            if (f.FireIncident !== fire.Incident) return false;
            const fd = f.FlightDate ? new Date(f.FlightDate) : null;
            if (!fd || isNaN(fd)) return false;
            return fd >= start && fd <= end;
          });

          return { ...fire, flights: matches };
        });
      }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </body>
</html>
