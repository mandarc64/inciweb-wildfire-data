<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Wildfire Incident Data</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Bootstrap 5 -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- DataTables -->
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.dataTables.min.css"
    />

    <style>
      body {
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        font-family: "Segoe UI", Tahoma, sans-serif;
      }
      .header-section {
        text-align: center;
        padding: 40px 20px 20px;
      }
      .header-section h1 {
        font-size: 2.5rem;
        font-weight: bold;
        color: #dc3545; /* red accent */
      }
      .header-section p {
        font-size: 1rem;
        color: #6c757d;
      }
      .card {
        background: #ffffff;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        padding: 20px;
        margin-top: 20px;
      }
      #lastUpdated {
        font-size: 0.95rem;
        color: #495057;
        margin-top: 10px;
      }
      select.form-select {
        border-radius: 8px;
        padding: 10px;
      }
      .loading {
        text-align: center;
        font-size: 1.1em;
        padding: 20px;
        color: #6c757d;
      }
      footer {
        text-align: center;
        margin-top: 40px;
        font-size: 0.85rem;
        color: #6c757d;
      }
    </style>
  </head>
  <body>
    <!-- HEADER -->
    <div class="header-section">
      <h1>üî• Wildfire Incident Dashboard</h1>
      <p>
        Live wildfire data auto-fetched from InciWeb. Updated daily at <b>8:00 AM PST</b>.
      </p>
      <!-- ‚úÖ Last Updated Placeholder -->
      <p id="lastUpdated" class="text-muted">‚è≥ Loading last update time...</p>
    </div>

    <div class="container">
      <!-- CARD UI -->
      <div class="card">
        <h5 class="text-center mb-3">Select an Incident</h5>
        <div class="mb-4 text-center">
          <select id="csvSelect" class="form-select w-50 mx-auto"></select>
        </div>

        <!-- TABLE -->
        <div id="tableContainer" class="table-responsive">
          <div class="loading">Loading available CSV files...</div>
          <table
            id="incidentTable"
            class="display nowrap table table-striped table-hover align-middle"
            style="width: 100%"
          ></table>
        </div>
      </div>
    </div>

    <!-- FOOTER -->
    <footer>
      üöÄ Built with ‚ù§Ô∏è | Last refreshed dynamically from GitHub API
    </footer>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <!-- PapaParse for CSV -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

    <!-- DataTables -->
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>

    <script>
      const GITHUB_USER = "mandarc64";
      const GITHUB_REPO = "inciweb-wildfire-data";
      const CSV_FOLDER = "inciweb_data";

      const csvBaseURL = `https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/master/${CSV_FOLDER}/`;
      const apiURL = `https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/${CSV_FOLDER}`;

      const csvSelect = document.getElementById("csvSelect");
      const tableContainer = document.getElementById("tableContainer");
      const lastUpdatedEl = document.getElementById("lastUpdated");

      let dataTable = null;

      // ‚úÖ Fetch CSV file list dynamically from GitHub API
      async function fetchCSVList() {
        try {
          const res = await fetch(apiURL);
          if (!res.ok) throw new Error("Failed to fetch file list");
          const files = await res.json();

          // Filter only .csv files
          const csvFiles = files
            .filter((file) => file.name.endsWith(".csv"))
            .map((file) => file.name)
            .sort();

          if (csvFiles.length === 0) {
            tableContainer.innerHTML = "<p>No CSV files found in repo.</p>";
            return;
          }

          // Populate dropdown dynamically
          csvSelect.innerHTML = "";
          csvFiles.forEach((file) => {
            const opt = document.createElement("option");
            opt.value = file;
            opt.textContent = file.replace(".csv", "").replace(/_/g, " ");
            csvSelect.appendChild(opt);
          });

          // Load first file by default
          loadCSV(csvFiles[0]);

          // Add change listener
          csvSelect.addEventListener("change", (e) => loadCSV(e.target.value));
        } catch (err) {
          console.error("Error fetching CSV list:", err);
          tableContainer.innerHTML = `<p>Error loading CSV list. Check console.</p>`;
        }
      }

      // ‚úÖ Load and parse CSV file
      function loadCSV(filename) {
        const csvURL = csvBaseURL + filename;
        console.log("Loading CSV:", csvURL);

        tableContainer.innerHTML = `<div class="loading">Loading ${filename}...</div>`;
        lastUpdatedEl.innerText = "‚è≥ Fetching last update time...";

        Papa.parse(csvURL, {
          download: true,
          header: true,
          skipEmptyLines: true,
          complete: function (results) {
            console.log("Parsed CSV:", results.data);

            const data = results.data;

            // ‚úÖ Update "Last Updated" timestamp dynamically
            updateLastUpdated(data);

            // ‚úÖ Render table
            renderTable(data);
          },
        });
      }

      // ‚úÖ Compute and display "Last updated at ..."
      function updateLastUpdated(data) {
        if (!data || data.length === 0) {
          lastUpdatedEl.innerText = "‚ö†Ô∏è No data available.";
          return;
        }

        // Get the most recent ScrapeDate from all rows
        const latestDate = data.reduce((latest, row) => {
          const d = new Date(row.ScrapeDate);
          return d > latest ? d : latest;
        }, new Date(0));

        if (!latestDate || isNaN(latestDate)) {
          lastUpdatedEl.innerText = "‚ö†Ô∏è Could not determine last update.";
          return;
        }

        // Format nicely in PST
        const formatted = latestDate.toLocaleString("en-US", {
          weekday: "short",
          year: "numeric",
          month: "short",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit",
          timeZone: "America/Los_Angeles",
        });

        lastUpdatedEl.innerHTML = `‚úÖ Updated daily at <b>8:00 AM PST</b> | <strong>Last data update:</strong> ${formatted}`;
      }

      // ‚úÖ Render DataTable
      function renderTable(data) {
        tableContainer.innerHTML = `<table id="incidentTable" class="display nowrap table table-striped" style="width:100%"></table>`;

        if (!data || data.length === 0) {
          tableContainer.innerHTML = "<p>No data found.</p>";
          return;
        }

        // ‚úÖ Get headers dynamically from the FIRST row
        const headers = Object.keys(data[0]);
        console.log("Detected Headers:", headers);

        const columns = headers.map((col) => ({
          title: col,
          data: col || null,
        }));

        // Destroy old DataTable if it exists
        if (dataTable) {
          dataTable.destroy();
        }

        dataTable = $("#incidentTable").DataTable({
          data: data,
          columns: columns,
          responsive: true,
          scrollX: true,
          pageLength: 10,
          autoWidth: false,
          columnDefs: [{ defaultContent: "-", targets: "_all" }],
        });
      }

      // ‚úÖ Start by fetching CSV list
      fetchCSVList();
    </script>
  </body>
</html>
