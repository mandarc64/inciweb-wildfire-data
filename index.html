<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Wildfire Incident Data</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Bootstrap 5 -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <link
      href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css"
      rel="stylesheet"
    />

    <!-- DataTables -->
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.dataTables.min.css"
    />
    <!-- DataTables Buttons CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css"
    />

    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

    <style>
      :root {
        --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --danger-gradient: #ff5a00;
        --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        --dark-bg: #f8f9fa;
        --card-bg: #ffffff;
        --border-color: #e2e8f0;
        --text-primary: #2d3748;
        --text-secondary: #718096;
        --accent-orange: #ff6b35;
        --accent-blue: #4fc3f7;
        --glass-bg: rgba(255, 255, 255, 0.8);
        --glass-border: rgba(0, 0, 0, 0.1);
        --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1),
          0 10px 10px -5px rgba(0, 0, 0, 0.04);
        --shadow-xl: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
      }

      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        color: var(--text-primary);
        line-height: 1.6;
        overflow-x: hidden;
      }

      /* Animated background */
      body::before {
        content: "";
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(
            circle at 20% 80%,
            rgba(255, 107, 53, 0.05) 0%,
            transparent 50%
          ),
          radial-gradient(
            circle at 80% 20%,
            rgba(79, 195, 247, 0.05) 0%,
            transparent 50%
          ),
          radial-gradient(
            circle at 40% 40%,
            rgba(118, 75, 162, 0.03) 0%,
            transparent 50%
          );
        z-index: -1;
        animation: float 20s ease-in-out infinite;
      }

      @keyframes float {
        0%,
        100% {
          transform: translateY(0px);
        }
        50% {
          transform: translateY(-20px);
        }
      }

      /* Header Section */
      .header-section {
        text-align: center;
        padding: 4rem 2rem 3rem;
        position: relative;
      }

      .header-section::after {
        content: "";
        position: absolute;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 100px;
        height: 2px;
        background: var(--danger-gradient);
        border-radius: 2px;
      }

      .header-section h1 {
        font-size: clamp(2.5rem, 5vw, 4rem);
        font-weight: 700;
        background: var(--danger-gradient);
        background-clip: text;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 1.5rem;
        letter-spacing: -0.02em;
      }

      .header-subtitle {
        font-size: 1.2rem;
        color: var(--text-secondary);
        margin-bottom: 2rem;
        font-weight: 400;
      }

      .status-grid {
        display: grid;
        grid-template-columns: repeat(6, 1fr);
        gap: 1rem;
        margin-top: 2rem;
        max-width: 1200px;
        margin-left: auto;
        margin-right: auto;
      }

      .status-card {
        background: var(--glass-bg);
        border: 1px solid var(--glass-border);
        border-radius: 16px;
        padding: 1rem;
        backdrop-filter: blur(10px);
        transition: all 0.3s ease;
      }

      .status-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-lg);
        border-color: var(--accent-orange);
      }

      .status-card .icon {
        width: 40px;
        height: 40px;
        margin-bottom: 0.75rem;
        color: var(--accent-orange);
      }

      .status-card h3 {
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.5rem;
      }

      .status-card .value {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text-primary);
      }

      /* Main Container */
      .container-fluid {
        max-width: 1400px;
        margin: 0 auto;
        padding: 0 2rem;
      }

      /* Glass Card */
      .glass-card {
        background: var(--glass-bg);
        border: 1px solid var(--glass-border);
        border-radius: 24px;
        padding: 2.5rem;
        backdrop-filter: blur(20px);
        box-shadow: var(--shadow-xl);
        margin-bottom: 2rem;
        transition: all 0.3s ease;
      }

      .glass-card:hover {
        border-color: rgba(255, 255, 255, 0.2);
      }

      /* Controls Section */
      .controls-section {
        display: flex;
        flex-wrap: wrap;
        gap: 1.5rem;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 3rem;
        padding: 1.5rem;
        background: var(--glass-bg);
        border: 1px solid var(--glass-border);
        border-radius: 16px;
        backdrop-filter: blur(10px);
      }

      .control-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      .control-group label {
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .form-select {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 0.75rem 2.5rem 0.75rem 1rem;
        color: var(--text-primary);
        font-weight: 500;
        min-width: 250px;
        transition: all 0.3s ease;
        appearance: none !important;
        -webkit-appearance: none !important;
        -moz-appearance: none !important;
        background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23718096' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right 1rem center;
        background-size: 16px;
      }

      .form-select::-ms-expand {
        display: none;
      }

      .form-select:focus {
        border-color: var(--accent-orange);
        box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
        background-color: var(--card-bg);
        color: var(--text-primary);
        outline: none;
        background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23ff6b35' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
      }

      .form-select option {
        background: var(--card-bg);
        color: var(--text-primary);
      }

      /* Export Buttons */
      .export-controls {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
      }

      .btn-export {
        background: var(--glass-bg);
        border: 1px solid var(--glass-border);
        color: var(--text-primary);
        padding: 0.75rem 1.5rem;
        border-radius: 12px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.3s ease;
        text-decoration: none;
      }

      .btn-export:hover {
        background: var(--accent-orange);
        border-color: var(--accent-orange);
        color: white;
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
      }

      /* Charts Section */
      .charts-section {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 2fr));
        gap: 2rem;
        margin-bottom: 3rem;
      }

      .chart-container {
        background: var(--glass-bg);
        border: 1px solid var(--glass-border);
        border-radius: 20px;
        padding: 2rem 2rem 3rem 2rem;
        backdrop-filter: blur(10px);
        transition: all 0.3s ease;
        min-width: 450px;
      }

      .chart-container:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-lg);
      }

      .chart-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 1.5rem;
        text-align: center;
      }

      /* Table Styles */
      .table-container {
        background: var(--glass-bg);
        border: 1px solid var(--glass-border);
        border-radius: 20px;
        padding: 2rem;
        backdrop-filter: blur(10px);
        overflow: hidden;
      }

      .table-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        flex-wrap: wrap;
        gap: 1rem;
      }

      .table-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      /* DataTables Overrides */
      .dataTables_wrapper {
        color: var(--text-primary);
      }

      .dataTables_wrapper .dataTables_length,
      .dataTables_wrapper .dataTables_filter,
      .dataTables_wrapper .dataTables_info,
      .dataTables_wrapper .dataTables_paginate {
        color: var(--text-secondary);
      }

      .dataTables_wrapper .dataTables_filter input {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 0.5rem;
        color: var(--text-primary);
        margin-left: 0.5rem;
      }

      table.dataTable {
        background: transparent;
        border-collapse: separate;
        border-spacing: 0;
      }

      table.dataTable thead th {
        background: var(--card-bg);
        color: var(--text-primary);
        border-bottom: 2px solid var(--border-color);
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.875rem;
        letter-spacing: 0.05em;
        padding: 1rem;
      }

      table.dataTable tbody tr {
        background: var(--glass-bg);
        border-bottom: 1px solid var(--border-color);
        transition: all 0.3s ease;
      }

      table.dataTable tbody tr:hover {
        background: rgba(255, 107, 53, 0.1);
      }

      table.dataTable tbody td {
        padding: 1rem;
        color: var(--text-primary);
        border-bottom: 1px solid var(--border-color);
      }

      .show-flights {
        background: var(--success-gradient);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        text-decoration: none;
        font-size: 0.875rem;
        font-weight: 500;
        transition: all 0.3s ease;
      }

      .show-flights:hover {
        transform: scale(1.05);
        color: white;
        text-decoration: none;
      }

      /* Flights Block */
      .flights-block {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 16px;
        padding: 1.5rem;
        margin-top: 1rem;
      }

      .flights-block table {
        background: transparent;
        color: var(--text-primary);
      }

      .flights-block table th {
        background: var(--glass-bg);
        color: var(--text-secondary);
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.05em;
      }

      /* Loading States */
      .loading {
        text-align: center;
        padding: 3rem;
        color: var(--text-secondary);
        font-size: 1.1rem;
      }

      .loading::before {
        content: "";
        display: inline-block;
        width: 32px;
        height: 32px;
        border: 3px solid var(--border-color);
        border-top: 3px solid var(--accent-orange);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 1rem;
        vertical-align: middle;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* Footer */
      footer {
        text-align: center;
        padding: 3rem 2rem;
        color: var(--text-secondary);
        font-size: 0.875rem;
        border-top: 1px solid var(--border-color);
        margin-top: 4rem;
        background: var(--glass-bg);
        backdrop-filter: blur(10px);
      }

      /* Responsive Design */
      @media (max-width: 768px) {
        .header-section {
          padding: 2rem 1rem 2rem;
        }

        .container-fluid {
          padding: 0 1rem;
        }

        .glass-card {
          padding: 1.5rem;
        }

        .controls-section {
          flex-direction: column;
          align-items: stretch;
        }

        .form-select {
          min-width: 100%;
        }

        .charts-section {
          grid-template-columns: 1fr;
        }

        .chart-container {
          padding: 1.5rem;
        }

        .export-controls {
          justify-content: center;
        }

        .table-header {
          flex-direction: column;
          align-items: stretch;
        }
      }

      @media (max-width: 1200px) {
        .status-grid {
          grid-template-columns: repeat(3, 1fr);
        }
      }

      @media (max-width: 768px) {
        .status-grid {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      @media (max-width: 480px) {
        .status-grid {
          grid-template-columns: 1fr;
        }
      }

      /* Micro-animations */
      .glass-card,
      .status-card,
      .chart-container,
      .btn-export {
        animation: fadeInUp 0.6s ease-out;
      }

      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Hide default DataTables buttons - we'll create custom ones */
      .dt-buttons {
        display: none;
      }
    </style>
  </head>
  <body>
    <!-- HEADER -->
    <div class="header-section">
      <h1>🔥 FireTracker Pro</h1>
      <p class="header-subtitle">
        Comprehensive wildfire monitoring with real-time incident tracking and
        aerial response coordination
      </p>

      <div class="status-grid">
        <div class="status-card">
          <i data-lucide="clock" class="icon"></i>
          <h3>Last Updated</h3>
          <div class="value" id="lastUpdated">Loading...</div>
        </div>
        <div class="status-card">
          <i data-lucide="flame" class="icon"></i>
          <h3>Current Fire Size</h3>
          <div class="value" id="currentFireSize">Loading...</div>
        </div>
        <div class="status-card">
          <i data-lucide="trending-up" class="icon"></i>
          <h3>Growth Rate</h3>
          <div class="value" id="growthRate">Loading...</div>
        </div>
        <div class="status-card">
          <i data-lucide="shield-check" class="icon"></i>
          <h3>Containment Status</h3>
          <div class="value" id="containmentStatus">Loading...</div>
        </div>
        <div class="status-card">
          <i data-lucide="calendar-days" class="icon"></i>
          <h3>Days Active</h3>
          <div class="value" id="daysActive">Loading...</div>
        </div>
        <div class="status-card">
          <i data-lucide="plane" class="icon"></i>
          <h3>Flight Operations</h3>
          <div class="value" id="flightOperations">Loading...</div>
        </div>
      </div>
    </div>

    <div class="container-fluid">
      <!-- CONTROLS -->
      <div class="controls-section">
        <div class="control-group">
          <label for="csvSelect">Select Incident</label>
          <select
            id="csvSelect"
            class="form-select select2"
            data-placeholder="Search incidents..."
          >
            <option>Loading incidents...</option>
          </select>
        </div>

        <div class="export-controls" id="exportControls" style="display: none">
          <button class="btn-export" id="exportExcel">
            <i data-lucide="download" style="width: 16px; height: 16px"></i>
            Excel
          </button>
          <button class="btn-export" id="exportCSV">
            <i data-lucide="file-text" style="width: 16px; height: 16px"></i>
            CSV
          </button>
          <!-- <button class="btn-export" id="exportPDF">
            <i data-lucide="file" style="width: 16px; height: 16px"></i>
            PDF
          </button> -->
        </div>
      </div>

      <!-- CHARTS -->
      <div class="charts-section">
        <div class="chart-container">
          <h3 class="chart-title">
            <i
              data-lucide="trending-up"
              style="width: 20px; height: 20px; margin-right: 0.5rem"
            ></i>
            Fire Growth Over Time
          </h3>
          <canvas id="acresChart"></canvas>
        </div>
        <div class="chart-container">
          <h3 class="chart-title">
            <i
              data-lucide="shield-check"
              style="width: 20px; height: 20px; margin-right: 0.5rem"
            ></i>
            Containment Progress
          </h3>
          <canvas id="containmentChart"></canvas>
        </div>
        <div class="chart-container">
          <h3 class="chart-title">
            <i
              data-lucide="plane"
              style="width: 20px; height: 20px; margin-right: 0.5rem"
            ></i>
            Flight Activity Timeline
          </h3>
          <canvas id="flightsChart"></canvas>
        </div>
      </div>

      <!-- TABLE -->
      <div class="table-container">
        <div class="table-header">
          <h2 class="table-title">
            <i data-lucide="database" style="width: 24px; height: 24px"></i>
            Incident Details
          </h2>
        </div>

        <div id="tableContainer">
          <div class="loading">Loading incident data</div>
          <table
            id="incidentTable"
            class="display nowrap table table-striped table-hover align-middle"
            style="width: 100%"
          ></table>
        </div>
      </div>
    </div>

    <!-- FOOTER -->
    <footer>
      <div
        style="
          display: flex;
          justify-content: center;
          align-items: center;
          gap: 1rem;
          flex-wrap: wrap;
        "
      >
        <span>🚀 Powered by Advanced Analytics</span>
        <span>•</span>
        <span>📡 Real-time Data Integration</span>
        <span>•</span>
        <span>🛡️ Enterprise Security</span>
      </div>
    </footer>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <!-- PapaParse for CSV -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

    <!-- DataTables -->
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>

    <!-- JSZip for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <!-- pdfmake for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>

    <!-- DataTables Buttons -->
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
      // Initialize Lucide icons
      lucide.createIcons();

      const GITHUB_USER = "mandarc64";
      const GITHUB_REPO = "inciweb-wildfire-data";
      const CSV_FOLDER = "inciweb_data";

      const csvSelect = document.getElementById("csvSelect");
      const tableContainer = document.getElementById("tableContainer");
      const lastUpdatedEl = document.getElementById("lastUpdated");
      const exportControls = document.getElementById("exportControls");

      const incidentMap = new Map(); // label(lowercased) -> filename
      const searchInput = document.getElementById("incidentSearch");
      const incidentList = document.getElementById("incidentList");

      const BRANCH = "master";
      const csvBaseURL = `https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/${BRANCH}/${CSV_FOLDER}/`;
      const apiURL = `https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/${CSV_FOLDER}?ref=${BRANCH}`;

      const FLIGHT_FOLDER = "flight_fire_data";
      const flightApiURL = `https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/${FLIGHT_FOLDER}?ref=${BRANCH}`;
      const MAX_FLIGHT_FILES = 60;

      let dataTable = null;
      let flightsData = [];
      const flightsReady = loadFlights();

      // Custom export button handlers
      document.getElementById("exportExcel").addEventListener("click", () => {
        if (dataTable) dataTable.button(".buttons-excel").trigger();
      });

      document.getElementById("exportCSV").addEventListener("click", () => {
        if (dataTable) dataTable.button(".buttons-csv").trigger();
      });

      //   document.getElementById("exportPDF").addEventListener("click", () => {
      //     if (dataTable) dataTable.button(".buttons-pdf").trigger();
      //   });

      async function loadFlights() {
        try {
          console.log("[Flights] Listing files in", flightApiURL);
          const res = await fetch(flightApiURL);
          if (!res.ok) throw new Error("Failed to list flight files");
          const files = await res.json();

          const csvs = (files || []).filter(
            (f) => f.type === "file" && f.name.toLowerCase().endsWith(".csv")
          );
          if (!csvs.length) {
            console.warn("[Flights] No flight CSVs found.");
            flightsData = [];
            return;
          }

          csvs.sort((a, b) => a.name.localeCompare(b.name));
          const recent = csvs.slice(-MAX_FLIGHT_FILES);
          console.log(
            `[Flights] Will load ${recent.length} of ${csvs.length} files (limit=${MAX_FLIGHT_FILES}).`
          );

          const parseOne = (name) =>
            new Promise((resolve) => {
              const url = `https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/${BRANCH}/${FLIGHT_FOLDER}/${name}`;
              Papa.parse(url, {
                download: true,
                header: true,
                skipEmptyLines: true,
                complete: (r) => resolve(r.data || []),
                error: (e) => {
                  console.warn("[Flights] parse error for", name, e);
                  resolve([]);
                },
              });
            });

          const allArrays = await Promise.all(
            recent.map((f) => parseOne(f.name))
          );
          const combined = allArrays.flat();
          console.log(
            `[Flights] Loaded ${combined.length} rows before de-dup.`
          );

          const byKey = new Map();
          const keyOf = (r) =>
            `${r.TailNumber || ""}|${r.FlightDate || ""}|${r.Origin || ""}|${
              r.Destination || ""
            }|${r.FireIncident || ""}`;

          for (const row of combined) {
            byKey.set(keyOf(row), row);
          }

          flightsData = Array.from(byKey.values());
          console.log(`[Flights] After de-dup: ${flightsData.length} rows.`);

          if (flightsData.length) {
            console.log("[Flights] Sample row:", flightsData[0]);
          }
        } catch (e) {
          console.error("Flight data load error:", e);
          flightsData = [];
        }
      }

      async function fetchCSVList() {
        try {
          const res = await fetch(apiURL);
          if (!res.ok) throw new Error("Failed to fetch file list");
          const files = await res.json();

          const csvFiles = files
            .filter((file) => file.name.endsWith(".csv"))
            .map((file) => file.name);

          if (!csvFiles.length) {
            tableContainer.innerHTML = "<p>No CSV files found in repo.</p>";
            return;
          }

          // Get DateOfOrigin from each CSV and sort newest → oldest
          const withDates = await Promise.all(
            csvFiles.map(
              (file) =>
                new Promise((resolve) => {
                  Papa.parse(csvBaseURL + file, {
                    download: true,
                    header: true,
                    preview: 2,
                    complete: (r) => {
                      const first = r.data?.[0] || {};
                      const d =
                        parseOriginDate(first.DateOfOrigin || "") ||
                        new Date(0);
                      resolve({
                        file,
                        date: d,
                        label: file.replace(".csv", "").replace(/_/g, " "),
                      });
                    },
                    error: () =>
                      resolve({
                        file,
                        date: new Date(0),
                        label: file.replace(".csv", "").replace(/_/g, " "),
                      }),
                  });
                })
            )
          );

          withDates.sort((a, b) => b.date - a.date);

          // Preserve current selection if any
          const previous = csvSelect.value;

          // Rebuild <select> options in sorted order
          csvSelect.innerHTML = "";
          withDates.forEach(({ file, label }) => {
            const opt = document.createElement("option");
            opt.value = file;
            opt.textContent = label;
            csvSelect.appendChild(opt);
          });

          exportControls.style.display = "flex";

          // Init / re-init Select2 on the existing dropdown to make it searchable
          const $sel = $("#csvSelect");
          if ($sel.hasClass("select2-hidden-accessible")) {
            $sel.select2("destroy");
          }
          $sel.select2({
            theme: "bootstrap-5",
            width: "400px",
            dropdownAutoWidth: true,
            minimumResultsForSearch: 0, // always show search box
            placeholder: $sel.data("placeholder") || "Search incidents...",
          });

          // Single change handler
          csvSelect.onchange = (e) => loadCSV(e.target.value);

          // Select previously chosen incident if still present, else the newest
          const toLoad =
            withDates.find((w) => w.file === previous)?.file ||
            withDates[0].file;

          // Set the value and trigger one change (loads the CSV once)
          $sel.val(toLoad).trigger("change");
        } catch (err) {
          console.error("Error fetching CSV list:", err);
          tableContainer.innerHTML = `<p>Error loading CSV list. Check console.</p>`;
        }
      }

      function loadCSV(filename) {
        const csvURL = csvBaseURL + filename;
        console.log("Loading CSV:", csvURL);

        tableContainer.innerHTML = `<div class="loading">Loading ${filename}</div>`;
        lastUpdatedEl.innerText = "Loading...";

        Papa.parse(csvURL, {
          download: true,
          header: true,
          skipEmptyLines: true,
          complete: async function (results) {
            console.log("Parsed CSV:", results.data);

            const data = results.data || [];
            await flightsReady;
            const enriched = attachFlightsToRows(data);

            updateLastUpdated(data);
            updateStatsCards(enriched);
            renderTable(enriched);
            renderCharts(enriched);
          },
        });
      }

      function parseUpdatedAgoToMs(s = "") {
        let ms = 0;
        const day = s.match(/(\d+)\s*day/);
        const hr = s.match(/(\d+)\s*hour/);
        const min = s.match(/(\d+)\s*min/);
        if (day) ms += Number(day[1]) * 86400000;
        if (hr) ms += Number(hr[1]) * 3600000;
        if (min) ms += Number(min[1]) * 60000;
        return ms;
      }

      function parseOriginDate(str = "") {
        const m = str.match(/(\d{2})\/(\d{2})\/(\d{4})/);
        if (!m) return null;

        const [, mmStr, ddStr, yyyyStr] = m;
        let yyyy = Number(yyyyStr);
        const mm = Number(mmStr);
        const dd = Number(ddStr);

        // InciWeb sometimes emits "00YY" (e.g., "0025") for 20YY years.
        if (yyyy < 100) yyyy += 2000; // "0025" -> 2025

        const d = new Date(Date.UTC(yyyy, mm - 1, dd));
        return isNaN(d) ? null : d;
      }

      function parseISODateOnly(iso = "") {
        const parts = iso.split("-");
        if (parts.length !== 3) return null;
        const [yyyy, mm, dd] = parts.map(Number);
        return new Date(Date.UTC(yyyy, mm - 1, dd));
      }

      function updateLastUpdated(data) {
        if (!data || data.length === 0) {
          lastUpdatedEl.innerText = "No data";
          return;
        }

        const latestDate = data.reduce((latest, row) => {
          const d = new Date(row.ScrapeDate);
          return d > latest ? d : latest;
        }, new Date(0));

        if (!latestDate || isNaN(latestDate)) {
          lastUpdatedEl.innerText = "Unknown";
          return;
        }

        const formatted = latestDate.toLocaleString("en-US", {
          month: "short",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit",
          timeZone: "America/Los_Angeles",
        });

        lastUpdatedEl.innerHTML = `${formatted} PST`;
      }

      function updateStatsCards(data) {
        if (!data || data.length === 0) {
          document.getElementById("currentFireSize").innerText = "No data";
          document.getElementById("growthRate").innerText = "No data";
          document.getElementById("containmentStatus").innerText = "No data";
          document.getElementById("daysActive").innerText = "No data";
          document.getElementById("flightOperations").innerText = "No data";
          return;
        }

        // Sort data by date to ensure chronological order
        const sortedData = [...data].sort(
          (a, b) => new Date(a.ScrapeDate) - new Date(b.ScrapeDate)
        );
        const latestData = sortedData[sortedData.length - 1];
        const firstData = sortedData[0];

        // 1. Current Fire Size
        const currentSize =
          parseFloat(latestData.Size.replace(/[^\d.]/g, "")) || 0;
        document.getElementById(
          "currentFireSize"
        ).innerText = `${currentSize.toLocaleString()} acres`;

        // 2. Growth Rate (acres per day)
        if (sortedData.length > 1) {
          const firstSize =
            parseFloat(firstData.Size.replace(/[^\d.]/g, "")) || 0;
          const daysDiff =
            (new Date(latestData.ScrapeDate) - new Date(firstData.ScrapeDate)) /
            (1000 * 60 * 60 * 24);
          const growthRate =
            daysDiff > 0 ? (currentSize - firstSize) / daysDiff : 0;
          document.getElementById("growthRate").innerText = `${Math.round(
            growthRate
          ).toLocaleString()} acres/day`;
        } else {
          document.getElementById("growthRate").innerText = "Insufficient data";
        }

        // 3. Containment Status
        const containment =
          parseFloat(latestData.ContainmentPercent?.replace("%", "")) || 0;
        const prevContainment =
          sortedData.length > 1
            ? parseFloat(
                sortedData[sortedData.length - 2].ContainmentPercent?.replace(
                  "%",
                  ""
                )
              ) || 0
            : containment;
        const trend =
          containment > prevContainment
            ? "↗️"
            : containment < prevContainment
            ? "↘️"
            : "➡️";
        document.getElementById(
          "containmentStatus"
        ).innerText = `${containment}% ${trend}`;

        // 4. Days Active
        const originDate = parseOriginDate(latestData.DateOfOrigin);
        if (originDate) {
          const daysActive = Math.ceil(
            (new Date(latestData.ScrapeDate) - originDate) /
              (1000 * 60 * 60 * 24)
          );
          document.getElementById(
            "daysActive"
          ).innerText = `${daysActive} days`;
        } else {
          document.getElementById("daysActive").innerText = "Unknown";
        }

        // 5. Flight Operations
        const totalFlights = data.reduce(
          (sum, row) =>
            sum + (Array.isArray(row.flights) ? row.flights.length : 0),
          0
        );
        document.getElementById(
          "flightOperations"
        ).innerText = `${totalFlights} flights`;
      }

      function renderTable(data) {
        tableContainer.innerHTML = `<table id="incidentTable" class="display nowrap table table-striped" style="width:100%"></table>`;

        if (!data || data.length === 0) {
          tableContainer.innerHTML = "<p>No data found.</p>";
          return;
        }

        const headers = Object.keys(data[0]).filter((h) => h !== "flights");
        console.log("Detected Headers:", headers);

        const columns = headers
          .filter((col) => col !== "flights")
          .map((col) => ({ title: col, data: col }));

        const scrapeDateIdx = headers.indexOf("ScrapeDate");
        const initialOrderIdx = scrapeDateIdx === -1 ? 0 : scrapeDateIdx;

        columns.push({
          title: "Flights",
          data: "flights",
          orderable: false,
          className: "all text-center",
          responsivePriority: 0,
          render: (flights, type, row) => {
            const n = Array.isArray(flights) ? flights.length : 0;

            if (type === "export") {
              if (!n) return "No flights";
              return flights
                .map(
                  (f) =>
                    `${f.FlightDate || ""} | ${f.TailNumber || ""} | ${
                      f.Origin || ""
                    } -> ${f.Destination || ""} | ${f.DistanceKM || ""} km`
                )
                .join("\n");
            }

            return n
              ? `<a href="#" class="show-flights" data-count="${n}">${n} flights</a>`
              : "—";
          },
        });

        if (dataTable) {
          dataTable.destroy();
        }

        const incidentName = data.length
          ? data[0].Incident.replace(/\s+/g, "_")
          : "wildfire";
        const timestamp = new Date().toISOString().replace(/[:.]/g, "-");

        dataTable = $("#incidentTable").DataTable({
          data: data,
          columns: columns,
          responsive: {
            details: {
              type: "inline",
              renderer: function (api, rowIdx, columns) {
                const rows = $.map(columns, function (col) {
                  if (!col.hidden) return "";
                  if (col.title === "Flights") return "";
                  return `
                <tr data-dt-row="${
                  col.rowIndex
                }" data-dt-column="${col.columnIndex}">
                  <td><strong>${col.title}</strong></td>
                  <td>${col.data !== null ? col.data : "-"}</td>
                </tr>`;
                }).join("");

                return rows
                  ? $('<table class="table table-sm mb-0"/>').append(rows)
                  : false;
              },
            },
          },

          scrollX: true,
          pageLength: 10,
          autoWidth: false,
          columnDefs: [{ defaultContent: "-", targets: "_all" }],
          order: [[initialOrderIdx, "desc"]],
          dom: "Bfrtip",

          buttons: [
            {
              extend: "excelHtml5",
              text: "📥 Download Excel",
              title: "Wildfire Incident Data",
              filename: `${incidentName}_${timestamp}`,
              exportOptions: { orthogonal: "export" },
              customize: function (xlsx) {
                const sheet = xlsx.xl.worksheets["sheet1.xml"];
                $("row c[r]", sheet).attr("s", "55");
              },
            },
            {
              extend: "csvHtml5",
              text: "📥 Download CSV",
              title: "Wildfire Incident Data",
              filename: `${incidentName}_${timestamp}`,
              exportOptions: { orthogonal: "export" },
              fieldBoundary: '"',
              escapeChar: '"',
              fieldSeparator: ",",
              customize: function (csv) {
                return csv;
              },
            },

            {
              extend: "pdfHtml5",
              text: "📄 Download PDF",
              title: "Wildfire Incident Data",
              orientation: "landscape",
              pageSize: "A4",
              filename: `${incidentName}_${timestamp}`,
              exportOptions: { orthogonal: "export" },
            },
            {
              extend: "print",
              exportOptions: { orthogonal: "export" },
            },
          ],
        });

        $("#incidentTable tbody").off("click", "a.show-flights");
        $("#incidentTable tbody").on("click", "a.show-flights", function (e) {
          e.preventDefault();
          e.stopPropagation();

          const dt = $("#incidentTable").DataTable();

          let $tr = $(this).closest("tr");
          if ($tr.hasClass("child")) $tr = $tr.prev("tr");

          const row = dt.row($tr);
          const rowData = row.data() || {};
          const flightCount = Array.isArray(rowData.flights)
            ? rowData.flights.length
            : 0;

          console.debug("[Flights click]", {
            parentRowIndex: row.index(),
            incident: rowData.Incident,
            scrapeDate: rowData.ScrapeDate,
            flights: flightCount,
          });

          let $child = $tr.next("tr.child");
          if (!$child.length || !$child.is(":visible")) {
            $tr.find("td.dtr-control").trigger("click");
            $child = $tr.next("tr.child");
          }

          const $cell = $child.children("td");
          if (!$cell.length) {
            console.warn("No child cell to inject flights block.");
            return;
          }

          const EXISTING_SEL = ".flights-block";
          const $existing = $cell.find(EXISTING_SEL);
          if ($existing.length) {
            console.debug("Removing flights block (toggle off).");
            $existing.remove();
            return;
          }

          console.debug("Injecting flights block…");
          const html = `
          <div class="flights-block border-top mt-2 pt-2">
            ${formatFlightsRow(rowData)}
          </div>`;
          $cell.append(html);
        });
      }

      fetchCSVList();

      let acresChart = null;
      let containmentChart = null;
      let flightsChart = null;

      function formatFlightsRow(rowData) {
        const flights = Array.isArray(rowData?.flights) ? rowData.flights : [];
        console.debug("formatFlightsRow()", {
          incident: rowData.Incident,
          count: flights.length,
        });
        if (!flights.length)
          return `<div class="p-2">No flights matched during this period.</div>`;

        const rows = flights
          .map(
            (f) => `
                <tr>
                  <td>${f.FlightDate || ""}</td>
                  <td>${f.TailNumber || ""}</td>
                  <td>${f.Origin || ""}</td>
                  <td>${f.Destination || ""}</td>
                  <td>${f.DistanceKM || ""}</td>
                </tr>
              `
          )
          .join("");

        return `
                <div class="p-2">
                  <strong>Matching flights (${flights.length})</strong>
                  <table class="table table-sm table-bordered mt-2 mb-0">
                    <thead>
                      <tr><th>Date</th><th>Tail #</th><th>Origin</th><th>Destination</th><th>Distance (km)</th></tr>
                    </thead>
                    <tbody>${rows}</tbody>
                  </table>
                </div>
              `;
      }

      function renderCharts(data) {
        // Set chart container heights FIRST, before creating charts
        const acresCanvas = document.getElementById("acresChart");
        const containmentCanvas = document.getElementById("containmentChart");

        acresCanvas.style.height = "300px";
        containmentCanvas.style.height = "300px";
        acresCanvas.parentElement.style.height = "350px"; // Give container some height too
        containmentCanvas.parentElement.style.height = "350px";

        const labels = data.map((d) => {
          const date = new Date(d.ScrapeDate);
          return date.toLocaleDateString("en-US", {
            month: "short",
            day: "numeric",
          });
        });

        const acres = data.map(
          (d) => parseFloat(d.Size.replace(/[^\d.]/g, "")) || 0
        );
        const containment = data.map(
          (d) => parseFloat(d.ContainmentPercent?.replace("%", "")) || 0
        );

        if (acresChart) acresChart.destroy();
        if (containmentChart) containmentChart.destroy();

        // Modern chart styling
        // In the renderCharts function, update chartOptions:
        const chartOptions = {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              labels: {
                color: "#718096",
                font: {
                  family: "Inter",
                  size: 12,
                },
              },
            },
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                color: "rgba(0, 0, 0, 0.1)",
                drawBorder: false,
              },
              ticks: {
                color: "#718096",
                font: {
                  family: "Inter",
                },
              },
            },
            x: {
              grid: {
                color: "rgba(0, 0, 0, 0.1)",
                drawBorder: false,
              },
              ticks: {
                color: "#718096",
                font: {
                  family: "Inter",
                },
              },
            },
          },
        };

        // Add a small delay to ensure DOM is ready
        setTimeout(() => {
          // Acres Chart
          acresChart = new Chart(acresCanvas, {
            type: "line",
            data: {
              labels: labels,
              datasets: [
                {
                  label: "Acres Burned",
                  data: acres,
                  fill: true,
                  borderWidth: 3,
                  borderColor: "#ff6b35",
                  backgroundColor: "rgba(255, 107, 53, 0.1)",
                  tension: 0.4,
                  pointBackgroundColor: "#ff6b35",
                  pointBorderColor: "#ffffff",
                  pointBorderWidth: 2,
                  pointRadius: 6,
                  pointHoverRadius: 8,
                },
              ],
            },
            options: {
              ...chartOptions,
              plugins: {
                ...chartOptions.plugins,
                title: {
                  display: false,
                },
              },
              scales: {
                ...chartOptions.scales,
                y: {
                  ...chartOptions.scales.y,
                  title: {
                    display: true,
                    text: "Acres Burned",
                    color: "#a0aec0",
                    font: {
                      family: "Inter",
                      size: 12,
                    },
                  },
                },
              },
            },
          });

          // Containment Chart
          containmentChart = new Chart(containmentCanvas, {
            type: "line",
            data: {
              labels: labels,
              datasets: [
                {
                  label: "Containment %",
                  data: containment,
                  fill: true,
                  borderWidth: 3,
                  borderColor: "#4fc3f7",
                  backgroundColor: "rgba(79, 195, 247, 0.1)",
                  tension: 0.4,
                  pointBackgroundColor: "#4fc3f7",
                  pointBorderColor: "#ffffff",
                  pointBorderWidth: 2,
                  pointRadius: 6,
                  pointHoverRadius: 8,
                },
              ],
            },
            options: {
              ...chartOptions,
              plugins: {
                ...chartOptions.plugins,
                title: {
                  display: false,
                },
              },
              scales: {
                ...chartOptions.scales,
                y: {
                  ...chartOptions.scales.y,
                  suggestedMax: 105,
                  grace: "5%",
                  ticks: {
                    ...chartOptions.scales.y.ticks,
                    callback: (v) => v + "%",
                    stepSize: 10,
                  },
                  title: {
                    display: true,
                    text: "Containment %",
                    color: "#a0aec0",
                    font: {
                      family: "Inter",
                      size: 12,
                    },
                  },
                },
              },
            },
          });
        }, 100); // Small delay to ensure DOM is ready

        const flightsByDate = {};
        data.forEach((row) => {
          if (Array.isArray(row.flights)) {
            row.flights.forEach((flight) => {
              const date = flight.FlightDate;
              if (date) {
                flightsByDate[date] = (flightsByDate[date] || 0) + 1;
              }
            });
          }
        });

        const flightLabels = labels; // Use same date labels as other charts
        const flightData = data.map((row) => {
          return Array.isArray(row.flights) ? row.flights.length : 0;
        });

        const flightsCanvas = document.getElementById("flightsChart");
        flightsCanvas.style.height = "300px";
        flightsCanvas.parentElement.style.height = "350px";

        if (flightsChart) flightsChart.destroy();

        setTimeout(() => {
          flightsChart = new Chart(flightsCanvas, {
            type: "line",
            data: {
              labels: labels,
              datasets: [
                {
                  label: "Flights per Day",
                  data: flightData,
                  fill: true,
                  borderWidth: 3,
                  borderColor: "#4fc3f7",
                  backgroundColor: "rgba(79, 195, 247, 0.1)",
                  tension: 0.4,
                  pointBackgroundColor: "#4fc3f7",
                  pointBorderColor: "#ffffff",
                  pointBorderWidth: 2,
                  pointRadius: 6,
                  pointHoverRadius: 8,
                },
              ],
            },
            options: {
              ...chartOptions,
              plugins: {
                ...chartOptions.plugins,
                title: {
                  display: false,
                },
              },
              scales: {
                ...chartOptions.scales,
                y: {
                  ...chartOptions.scales.y,
                  title: {
                    display: true,
                    text: "Number of Flights",
                    color: "#a0aec0",
                    font: {
                      family: "Inter",
                      size: 12,
                    },
                  },
                },
              },
            },
          });
        }, 100);
      }

      function attachFlightsToRows(fireRows) {
        if (!Array.isArray(fireRows) || !fireRows.length) return [];

        const output = fireRows.map((r) => ({ ...r, flights: [] }));

        const byIncident = new Map();
        fireRows.forEach((row, idx) => {
          const key = row.Incident || "__UNKNOWN__";
          if (!byIncident.has(key)) byIncident.set(key, []);
          byIncident.get(key).push({ row, idx });
        });

        for (const [incident, list] of byIncident.entries()) {
          list.sort(
            (a, b) => new Date(a.row.ScrapeDate) - new Date(b.row.ScrapeDate)
          );

          const origin = parseOriginDate(list[0].row.DateOfOrigin);
          if (!origin || isNaN(origin)) {
            continue;
          }

          let prevEnd = null;

          for (let i = 0; i < list.length; i++) {
            const { row, idx } = list[i];

            const scrape = new Date(row.ScrapeDate);
            const end = new Date(
              scrape.getTime() - parseUpdatedAgoToMs(row.Updated || "")
            );

            if (!end || isNaN(end)) {
              output[idx].flights = [];
              prevEnd = end;
              continue;
            }

            const windowStart = i === 0 ? origin : prevEnd;
            const inclusiveLower = i === 0;

            const matches = flightsData.filter((f) => {
              if (f.FireIncident !== incident) return false;
              const fd = f.FlightDate ? parseISODateOnly(f.FlightDate) : null;
              if (!fd || isNaN(fd)) return false;

              if (inclusiveLower) {
                return fd >= windowStart && fd <= end;
              } else {
                return windowStart && fd > windowStart && fd <= end;
              }
            });

            output[idx].flights = matches;
            prevEnd = end;
          }
        }

        return output;
      }
    </script>
  </body>
</html>
